<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
<title>libkate: /home/v/Kate/WORK_TREES/kate-sorceress-backup/v/src/kate/src/kate_decode.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.0 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>/home/v/Kate/WORK_TREES/kate-sorceress-backup/v/src/kate/src/kate_decode.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (C) 2008, 2009 Vincent Penquerc&apos;h.</span>
<a name="l00002"></a>00002 <span class="comment">   This file is part of the Kate codec library.</span>
<a name="l00003"></a>00003 <span class="comment">   Written by Vincent Penquerc&apos;h.</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">   Use, distribution and reproduction of this library is governed</span>
<a name="l00006"></a>00006 <span class="comment">   by a BSD style source license included with this source in the</span>
<a name="l00007"></a>00007 <span class="comment">   file &apos;COPYING&apos;. Please read these terms before distributing. */</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#define KATE_INTERNAL</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#include &quot;kate_internal.h&quot;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#ifdef HAVE_STDLIB_H</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#endif</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_STRING_H</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#endif</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor">#include &quot;kate/kate.h&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;kate_decode_state.h&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;kate_fp.h&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;kate_rle.h&quot;</span>
<a name="l00023"></a>00023 
<a name="l00025"></a><a class="code" href="structkate__memory__guard.html">00025</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> {
<a name="l00026"></a>00026   <span class="keywordtype">size_t</span> size;
<a name="l00027"></a>00027   <span class="keywordtype">void</span> **pointers;
<a name="l00028"></a>00028 } <a class="code" href="structkate__memory__guard.html">kate_memory_guard</a>;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">static</span> <span class="keywordtype">void</span> *kate_memory_guard_malloc(<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *kmg,<span class="keywordtype">size_t</span> size)
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032   <span class="keywordtype">void</span> **new_pointers;
<a name="l00033"></a>00033   <span class="keywordtype">void</span> *ptr;
<a name="l00034"></a>00034   <span class="keywordtype">int</span> ret;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   ret=kate_check_add_overflow(kmg-&gt;size,1,NULL);
<a name="l00037"></a>00037   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> NULL;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039   ptr=kate_malloc(size);
<a name="l00040"></a>00040   <span class="keywordflow">if</span> (!ptr) <span class="keywordflow">return</span> NULL;
<a name="l00041"></a>00041   new_pointers=(<span class="keywordtype">void</span>**)kate_checked_realloc(kmg-&gt;pointers,(kmg-&gt;size+1),<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*));
<a name="l00042"></a>00042   <span class="keywordflow">if</span> (!new_pointers) {
<a name="l00043"></a>00043     kate_free(ptr);
<a name="l00044"></a>00044     <span class="keywordflow">return</span> NULL;
<a name="l00045"></a>00045   }
<a name="l00046"></a>00046   kmg-&gt;pointers=new_pointers;
<a name="l00047"></a>00047   kmg-&gt;pointers[kmg-&gt;size++]=ptr;
<a name="l00048"></a>00048   <span class="keywordflow">return</span> ptr;
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">static</span> <span class="keywordtype">void</span> *kate_memory_guard_checked_malloc(<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *kmg,<span class="keywordtype">size_t</span> size1,<span class="keywordtype">size_t</span> size2)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053   <span class="keywordtype">size_t</span> size;
<a name="l00054"></a>00054   <span class="keywordtype">int</span> ret=kate_check_mul_overflow(size1,size2,&amp;size);
<a name="l00055"></a>00055   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> NULL;
<a name="l00056"></a>00056   <span class="keywordflow">return</span> kate_memory_guard_malloc(kmg,size);
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="keyword">static</span> <span class="keywordtype">void</span> kate_memory_guard_destroy(<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *kmg,<span class="keywordtype">int</span> free_pointers)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061   <span class="keywordtype">size_t</span> n;
<a name="l00062"></a>00062   <span class="keywordflow">if</span> (free_pointers) {
<a name="l00063"></a>00063     <span class="keywordflow">for</span> (n=0;n&lt;kmg-&gt;size;++n) kate_free(kmg-&gt;pointers[n]);
<a name="l00064"></a>00064   }
<a name="l00065"></a>00065   <span class="keywordflow">if</span> (kmg-&gt;pointers) kate_free(kmg-&gt;pointers);
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_memory_guard_merge(<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *kmg,<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *parent_kmg)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   <span class="keywordtype">void</span> **new_pointers;
<a name="l00071"></a>00071   <span class="keywordtype">int</span> ret;
<a name="l00072"></a>00072   <span class="keywordtype">size_t</span> new_size;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   ret=kate_check_add_overflow(parent_kmg-&gt;size,kmg-&gt;size,&amp;new_size);
<a name="l00075"></a>00075   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077   new_pointers=(<span class="keywordtype">void</span>**)kate_checked_realloc(parent_kmg-&gt;pointers,new_size,<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*));
<a name="l00078"></a>00078   <span class="keywordflow">if</span> (!new_pointers) {
<a name="l00079"></a>00079     kate_memory_guard_destroy(kmg,1);
<a name="l00080"></a>00080     <span class="keywordflow">return</span> KATE_E_OUT_OF_MEMORY;
<a name="l00081"></a>00081   }
<a name="l00082"></a>00082   parent_kmg-&gt;pointers=new_pointers;
<a name="l00083"></a>00083   memcpy(parent_kmg-&gt;pointers+parent_kmg-&gt;size,kmg-&gt;pointers,kmg-&gt;size*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*));
<a name="l00084"></a>00084   parent_kmg-&gt;size=new_size;
<a name="l00085"></a>00085   kate_memory_guard_destroy(kmg,0);
<a name="l00086"></a>00086   <span class="keywordflow">return</span> 0;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="preprocessor">#define KMG_GUARD() kate_memory_guard kmg={0,NULL}</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="preprocessor">#define KMG_MALLOC(size) kate_memory_guard_malloc(&amp;kmg,size)</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#define KMG_CHECKED_MALLOC(size1,size2) kate_memory_guard_checked_malloc(&amp;kmg,size1,size2)</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#define KMG_MERGE(parent_kmg) kate_memory_guard_merge(&amp;kmg,parent_kmg)</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#define KMG_ERROR(ret) (kate_memory_guard_destroy(&amp;kmg,1),ret)</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#define KMG_OK() (kate_memory_guard_destroy(&amp;kmg,0),0)</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_readbuf(kate_pack_buffer *kpb,<span class="keywordtype">char</span> *s,<span class="keywordtype">int</span> len)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100   <span class="keywordflow">if</span> (len&lt;0) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00101"></a>00101   <span class="keywordflow">if</span> ((kate_pack_readable_bits(kpb)+7)/8&lt;len) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00102"></a>00102   <span class="keywordflow">while</span> (len--) *s++=kate_pack_read(kpb,8);
<a name="l00103"></a>00103   <span class="keywordflow">return</span> 0;
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="keyword">static</span> kate_int32_t kate_read32(kate_pack_buffer *kpb)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108   kate_int32_t v=0;
<a name="l00109"></a>00109   v|=kate_pack_read(kpb,8);
<a name="l00110"></a>00110   v|=(kate_pack_read(kpb,8)&lt;&lt;8);
<a name="l00111"></a>00111   v|=(kate_pack_read(kpb,8)&lt;&lt;16);
<a name="l00112"></a>00112   v|=(kate_pack_read(kpb,8)&lt;&lt;24);
<a name="l00113"></a>00113   <span class="keywordflow">return</span> v;
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="keyword">static</span> kate_int32_t kate_read32v(kate_pack_buffer *kpb)
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118   <span class="comment">/* an error (negative) will be returned as negative, propagating the error</span>
<a name="l00119"></a>00119 <span class="comment">     to the caller even though the expected range for 4 bits is 0-15 */</span>
<a name="l00120"></a>00120   <span class="keywordtype">int</span> smallv=kate_pack_read(kpb,4);
<a name="l00121"></a>00121   <span class="keywordflow">if</span> (smallv==15) {
<a name="l00122"></a>00122     <span class="keywordtype">int</span> sign=kate_pack_read1(kpb);
<a name="l00123"></a>00123     <span class="keywordtype">int</span> bits=kate_pack_read(kpb,5)+1;
<a name="l00124"></a>00124     kate_int32_t v=kate_pack_read(kpb,bits);
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (sign) v=-v;
<a name="l00126"></a>00126     <span class="keywordflow">return</span> v;
<a name="l00127"></a>00127   }
<a name="l00128"></a>00128   <span class="keywordflow">else</span> <span class="keywordflow">return</span> smallv;
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="keyword">static</span> kate_int64_t kate_read64(kate_pack_buffer *kpb)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133   kate_int32_t vl=kate_read32(kpb);
<a name="l00134"></a>00134   kate_int32_t vh=kate_read32(kpb);
<a name="l00135"></a>00135   <span class="keywordflow">return</span> (0xffffffff&amp;(kate_int64_t)vl)|(((kate_int64_t)vh)&lt;&lt;32);
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_overread(kate_pack_buffer *kpb)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140   <span class="keywordflow">return</span> kate_pack_look(kpb,0)&lt;0;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_warp(kate_pack_buffer *kpb)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145   <span class="keywordflow">while</span> (1) {
<a name="l00146"></a>00146     kate_int32_t bits=kate_read32v(kpb);
<a name="l00147"></a>00147     <span class="keywordflow">if</span> (!bits) <span class="keywordflow">break</span>;
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (bits&lt;0) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00149"></a>00149     kate_pack_adv(kpb,bits);
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151   <span class="keywordflow">return</span> 0;
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_check_magic(kate_pack_buffer *kpb)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156   <span class="keywordtype">char</span> magic[8];
<a name="l00157"></a>00157   <span class="keywordtype">int</span> ret;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159   <span class="keywordflow">if</span> (!kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   ret=kate_readbuf(kpb,magic,7);
<a name="l00162"></a>00162   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KATE_E_NOT_KATE;
<a name="l00163"></a>00163   <span class="keywordflow">if</span> (memcmp(magic,<span class="stringliteral">&quot;kate\0\0\0&quot;</span>,7)) <span class="keywordflow">return</span> KATE_E_NOT_KATE;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165   <span class="keywordflow">return</span> 0;
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00175"></a>00175 <span class="keywordtype">int</span> kate_decode_is_idheader(<span class="keyword">const</span> kate_packet *kp)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177   kate_pack_buffer kpb;
<a name="l00178"></a>00178   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> headerid;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180   <span class="keywordflow">if</span> (!kp) <span class="keywordflow">return</span> 0;
<a name="l00181"></a>00181 
<a name="l00182"></a>00182   kate_pack_readinit(&amp;kpb,kp-&gt;data,kp-&gt;nbytes);
<a name="l00183"></a>00183   headerid=kate_pack_read(&amp;kpb,8);
<a name="l00184"></a>00184   <span class="keywordflow">if</span> (headerid!=0x80) <span class="keywordflow">return</span> 0;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <span class="keywordflow">return</span> !kate_decode_check_magic(&amp;kpb);
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_check_eop(kate_pack_buffer *kpb)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191   <span class="keywordtype">int</span> bits;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193   <span class="keywordflow">if</span> (!kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   <span class="comment">/* ensure any remaining bits in the current byte are zero (reading 0 bytes yields zero) */</span>
<a name="l00196"></a>00196   bits=7&amp;(8-(kate_pack_bits(kpb)&amp;7));
<a name="l00197"></a>00197   <span class="keywordflow">if</span> (bits&gt;0) {
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (kate_pack_read(kpb,bits)) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00199"></a>00199   }
<a name="l00200"></a>00200   <span class="keywordflow">if</span> (kate_pack_look1(kpb)&gt;=0) <span class="keywordflow">return</span> KATE_E_BAD_PACKET; <span class="comment">/* no more data expected */</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   <span class="keywordflow">return</span> 0;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_read_canvas_size(kate_pack_buffer *kpb)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207   <span class="keywordtype">size_t</span> base,shift;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="keywordflow">if</span> (!kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211   shift=kate_pack_read(kpb,4);
<a name="l00212"></a>00212   base=kate_pack_read(kpb,4);
<a name="l00213"></a>00213   base|=(kate_pack_read(kpb,8)&lt;&lt;4);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   <span class="keywordflow">return</span> base&lt;&lt;shift;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="preprocessor">#define KATE_IS_BITSTREAM_LOE(major,minor) (major)</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span>
<a name="l00220"></a>00220 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_info_header(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222   KMG_GUARD();
<a name="l00223"></a>00223   <span class="keywordtype">int</span> len;
<a name="l00224"></a>00224   <span class="keywordtype">int</span> ret;
<a name="l00225"></a>00225   <span class="keywordtype">char</span> *language,*category;
<a name="l00226"></a>00226   <span class="keywordtype">int</span> reserved;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   ki-&gt;bitstream_version_major=kate_pack_read(kpb,8);
<a name="l00231"></a>00231   ki-&gt;bitstream_version_minor=kate_pack_read(kpb,8);
<a name="l00232"></a>00232   <span class="keywordflow">if</span> (ki-&gt;bitstream_version_major&gt;KATE_BITSTREAM_VERSION_MAJOR) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_VERSION);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   ki-&gt;num_headers=kate_pack_read(kpb,8);
<a name="l00235"></a>00235   <span class="keywordflow">if</span> (ki-&gt;num_headers&lt;1) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00236"></a>00236   ki-&gt;text_encoding=kate_pack_read(kpb,8);
<a name="l00237"></a>00237   ki-&gt;text_directionality=kate_pack_read(kpb,8);
<a name="l00238"></a>00238   reserved=kate_pack_read(kpb,8);
<a name="l00239"></a>00239   <span class="keywordflow">if</span> (ki-&gt;bitstream_version_major==0 &amp;&amp; ki-&gt;bitstream_version_minor&lt;3) {
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (reserved!=0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET); <span class="comment">/* reserved - 0 */</span>
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242   ki-&gt;granule_shift=kate_pack_read(kpb,8);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   ret=kate_decode_read_canvas_size(kpb);
<a name="l00245"></a>00245   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00246"></a>00246   ki-&gt;original_canvas_width=ret;
<a name="l00247"></a>00247   ret=kate_decode_read_canvas_size(kpb);
<a name="l00248"></a>00248   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00249"></a>00249   ki-&gt;original_canvas_height=ret;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   reserved=kate_read32(kpb);
<a name="l00252"></a>00252   <span class="keywordflow">if</span> (ki-&gt;bitstream_version_major==0 &amp;&amp; ki-&gt;bitstream_version_minor&lt;3) {
<a name="l00253"></a>00253     <span class="keywordflow">if</span> (reserved!=0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET); <span class="comment">/* reserved - 0 */</span>
<a name="l00254"></a>00254   }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   ki-&gt;gps_numerator=kate_read32(kpb);
<a name="l00257"></a>00257   ki-&gt;gps_denominator=kate_read32(kpb);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="keywordflow">if</span> (ki-&gt;granule_shift&gt;=64) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00260"></a>00260   <span class="keywordflow">if</span> (ki-&gt;gps_numerator==0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00261"></a>00261   <span class="keywordflow">if</span> (ki-&gt;gps_denominator==0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00262"></a>00262   <span class="comment">/*</span>
<a name="l00263"></a>00263 <span class="comment">  should not be needed anymore, calculations on these should be ok with full 32 bit range</span>
<a name="l00264"></a>00264 <span class="comment">  if ((ki-&gt;gps_numerator^ki-&gt;gps_denominator)&lt;0) return KMG_ERROR(KATE_E_BAD_PACKET);</span>
<a name="l00265"></a>00265 <span class="comment">  */</span>
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   len=16;
<a name="l00268"></a>00268   language=(<span class="keywordtype">char</span>*)KMG_MALLOC(len);
<a name="l00269"></a>00269   <span class="keywordflow">if</span> (!language) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00270"></a>00270   ret=kate_readbuf(kpb,language,len); <span class="comment">/* a terminating null is included */</span>
<a name="l00271"></a>00271   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00272"></a>00272   <span class="keywordflow">if</span> (language[len-1]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET); <span class="comment">/* but do check it to be sure */</span>
<a name="l00273"></a>00273 
<a name="l00274"></a>00274   len=16;
<a name="l00275"></a>00275   category=(<span class="keywordtype">char</span>*)KMG_MALLOC(len);
<a name="l00276"></a>00276   <span class="keywordflow">if</span> (!category) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00277"></a>00277   ret=kate_readbuf(kpb,category,len); <span class="comment">/* a terminating null is included */</span>
<a name="l00278"></a>00278   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00279"></a>00279   <span class="keywordflow">if</span> (category[len-1]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET); <span class="comment">/* but do check it to be sure */</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   ret=kate_check_eop(kpb);
<a name="l00282"></a>00282   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   ki-&gt;language=language;
<a name="l00285"></a>00285   ki-&gt;category=category;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="keywordflow">return</span> KMG_OK();
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_comment_packet(<span class="keyword">const</span> kate_info *ki,kate_comment *kc,kate_pack_buffer *kpb)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292   KMG_GUARD();
<a name="l00293"></a>00293   <span class="keywordtype">int</span> ret,len,nc;
<a name="l00294"></a>00294   <span class="keywordtype">char</span> **user_comments,*vendor;
<a name="l00295"></a>00295   <span class="keywordtype">int</span> comments,*comment_lengths;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   <span class="keywordflow">if</span> (!ki || !kc || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   len=kate_read32(kpb);
<a name="l00300"></a>00300   <span class="keywordflow">if</span> (len&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00301"></a>00301   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_COMMENT_LENGTH) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00302"></a>00302   vendor=(<span class="keywordtype">char</span>*)KMG_MALLOC(len+1);
<a name="l00303"></a>00303   <span class="keywordflow">if</span> (!vendor) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00304"></a>00304   ret=kate_readbuf(kpb,vendor,len);
<a name="l00305"></a>00305   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00306"></a>00306   vendor[len]=0;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   comments=kate_read32(kpb);
<a name="l00309"></a>00309   <span class="keywordflow">if</span> (comments&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00310"></a>00310   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_COMMENTS) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00311"></a>00311   user_comments=(<span class="keywordtype">char</span>**)KMG_CHECKED_MALLOC(comments,<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*));
<a name="l00312"></a>00312   comment_lengths=(<span class="keywordtype">int</span>*)KMG_CHECKED_MALLOC(comments,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00313"></a>00313   <span class="keywordflow">if</span> (!user_comments || !comment_lengths) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315   <span class="keywordflow">for</span> (nc=0;nc&lt;comments;++nc) user_comments[nc]=NULL;
<a name="l00316"></a>00316   <span class="keywordflow">for</span> (nc=0;nc&lt;comments;++nc) {
<a name="l00317"></a>00317     len=kate_read32(kpb);
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (len&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00319"></a>00319     <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_COMMENT_LENGTH) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00320"></a>00320     user_comments[nc]=(<span class="keywordtype">char</span>*)KMG_MALLOC(len+1);
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (!user_comments[nc]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00322"></a>00322     <span class="keywordflow">if</span> (len) {
<a name="l00323"></a>00323       ret=kate_readbuf(kpb,user_comments[nc],len);
<a name="l00324"></a>00324       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326     user_comments[nc][len]=0;
<a name="l00327"></a>00327     comment_lengths[nc]=len;
<a name="l00328"></a>00328   }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   ret=kate_check_eop(kpb);
<a name="l00331"></a>00331   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333   kc-&gt;user_comments=user_comments;
<a name="l00334"></a>00334   kc-&gt;comment_lengths=comment_lengths;
<a name="l00335"></a>00335   kc-&gt;comments=comments;
<a name="l00336"></a>00336   kc-&gt;vendor=vendor;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="keywordflow">return</span> KMG_OK();
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_region(<span class="keyword">const</span> kate_info *ki,kate_region *kr,kate_pack_buffer *kpb)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343   <span class="keywordflow">if</span> (!kr || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00344"></a>00344   kr-&gt;metric=kate_pack_read(kpb,8);
<a name="l00345"></a>00345   kr-&gt;x=kate_read32v(kpb);
<a name="l00346"></a>00346   kr-&gt;y=kate_read32v(kpb);
<a name="l00347"></a>00347   kr-&gt;w=kate_read32v(kpb);
<a name="l00348"></a>00348   kr-&gt;h=kate_read32v(kpb);
<a name="l00349"></a>00349   kr-&gt;style=kate_read32v(kpb);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <span class="keywordflow">if</span> (((ki-&gt;bitstream_version_major&lt;&lt;8)|ki-&gt;bitstream_version_minor)&gt;=0x0002) {
<a name="l00352"></a>00352     <span class="comment">/* 0.2 adds a warp for clip */</span>
<a name="l00353"></a>00353     kate_read32v(kpb); <span class="comment">/* the size of the warp */</span>
<a name="l00354"></a>00354     kr-&gt;clip=kate_pack_read1(kpb);
<a name="l00355"></a>00355   }
<a name="l00356"></a>00356   <span class="keywordflow">else</span> {
<a name="l00357"></a>00357     kr-&gt;clip=0;
<a name="l00358"></a>00358   }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="keywordflow">return</span> kate_warp(kpb);
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_regions_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365   KMG_GUARD();
<a name="l00366"></a>00366   <span class="keywordtype">int</span> ret,n,nregions;
<a name="l00367"></a>00367   kate_region **regions;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   nregions=kate_read32v(kpb);
<a name="l00372"></a>00372   <span class="keywordflow">if</span> (nregions&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00373"></a>00373   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nregions&gt;KATE_LIMIT_REGIONS) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00374"></a>00374   regions=(kate_region**)KMG_CHECKED_MALLOC(nregions,<span class="keyword">sizeof</span>(kate_region*));
<a name="l00375"></a>00375   <span class="keywordflow">if</span> (!regions) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00376"></a>00376   <span class="keywordflow">for</span> (n=0;n&lt;nregions;++n) {
<a name="l00377"></a>00377     regions[n]=(kate_region*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_region));
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (!regions[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00379"></a>00379     ret=kate_decode_region(ki,regions[n],kpb);
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00382"></a>00382   }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   ret=kate_warp(kpb);
<a name="l00385"></a>00385   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   ret=kate_check_eop(kpb);
<a name="l00388"></a>00388   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390   ki-&gt;nregions=nregions;
<a name="l00391"></a>00391   ki-&gt;regions=regions;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="keywordflow">return</span> KMG_OK();
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_color(kate_color *kc,kate_pack_buffer *kpb)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398   <span class="keywordflow">if</span> (!kc || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00399"></a>00399   kc-&gt;r=kate_pack_read(kpb,8);
<a name="l00400"></a>00400   kc-&gt;g=kate_pack_read(kpb,8);
<a name="l00401"></a>00401   kc-&gt;b=kate_pack_read(kpb,8);
<a name="l00402"></a>00402   kc-&gt;a=kate_pack_read(kpb,8);
<a name="l00403"></a>00403   <span class="keywordflow">return</span> 0;
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_style(<span class="keyword">const</span> kate_info *ki,kate_style *ks,kate_pack_buffer *kpb,<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *parent_kmg)
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408   KMG_GUARD();
<a name="l00409"></a>00409   <span class="keywordtype">int</span> ret;
<a name="l00410"></a>00410   kate_float d[8];
<a name="l00411"></a>00411   <span class="keywordtype">size_t</span> idx;
<a name="l00412"></a>00412   <span class="keywordtype">int</span> len;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   <span class="keywordflow">if</span> (!ks || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   ret=kate_fp_decode_kate_float(<span class="keyword">sizeof</span>(d)/<span class="keyword">sizeof</span>(d[0]),d,1,kpb);
<a name="l00417"></a>00417   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419   idx=0;
<a name="l00420"></a>00420   ks-&gt;halign=d[idx++];
<a name="l00421"></a>00421   ks-&gt;valign=d[idx++];
<a name="l00422"></a>00422   ks-&gt;font_width=d[idx++];
<a name="l00423"></a>00423   ks-&gt;font_height=d[idx++];
<a name="l00424"></a>00424   ks-&gt;left_margin=d[idx++];
<a name="l00425"></a>00425   ks-&gt;top_margin=d[idx++];
<a name="l00426"></a>00426   ks-&gt;right_margin=d[idx++];
<a name="l00427"></a>00427   ks-&gt;bottom_margin=d[idx++];
<a name="l00428"></a>00428   ret=kate_decode_color(&amp;ks-&gt;text_color,kpb);
<a name="l00429"></a>00429   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00430"></a>00430   ret=kate_decode_color(&amp;ks-&gt;background_color,kpb);
<a name="l00431"></a>00431   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00432"></a>00432   ret=kate_decode_color(&amp;ks-&gt;draw_color,kpb);
<a name="l00433"></a>00433   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00434"></a>00434   ks-&gt;font_metric=kate_pack_read(kpb,8);
<a name="l00435"></a>00435   ks-&gt;margin_metric=kate_pack_read(kpb,8);
<a name="l00436"></a>00436   ks-&gt;bold=kate_pack_read1(kpb);
<a name="l00437"></a>00437   ks-&gt;italics=kate_pack_read1(kpb);
<a name="l00438"></a>00438   ks-&gt;underline=kate_pack_read1(kpb);
<a name="l00439"></a>00439   ks-&gt;strike=kate_pack_read1(kpb);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (((ki-&gt;bitstream_version_major&lt;&lt;8)|ki-&gt;bitstream_version_minor)&gt;=0x0002) {
<a name="l00442"></a>00442     <span class="comment">/* 0.2 adds a warp for justify and font */</span>
<a name="l00443"></a>00443     kate_read32v(kpb); <span class="comment">/* the size of the warp */</span>
<a name="l00444"></a>00444     ks-&gt;justify=kate_pack_read1(kpb);
<a name="l00445"></a>00445     len=kate_read32v(kpb);
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (len&lt;0) {
<a name="l00447"></a>00447       <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len&gt;0) {
<a name="l00450"></a>00450       ks-&gt;font=(<span class="keywordtype">char</span>*)KMG_MALLOC(len+1);
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (!ks-&gt;font) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00452"></a>00452       ret=kate_readbuf(kpb,ks-&gt;font,len);
<a name="l00453"></a>00453       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00454"></a>00454       ks-&gt;font[len]=0;
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456     <span class="keywordflow">else</span> {
<a name="l00457"></a>00457       ks-&gt;font=NULL;
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459   }
<a name="l00460"></a>00460   <span class="keywordflow">else</span> {
<a name="l00461"></a>00461     ks-&gt;justify=0;
<a name="l00462"></a>00462     ks-&gt;font=NULL;
<a name="l00463"></a>00463   }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   <span class="keywordflow">if</span> (((ki-&gt;bitstream_version_major&lt;&lt;8)|ki-&gt;bitstream_version_minor)&gt;=0x0004) {
<a name="l00466"></a>00466     <span class="comment">/* 0.4 adds a warp for wrap mode */</span>
<a name="l00467"></a>00467     kate_read32v(kpb); <span class="comment">/* the size of the warp */</span>
<a name="l00468"></a>00468     ks-&gt;wrap_mode=kate_read32v(kpb);
<a name="l00469"></a>00469   }
<a name="l00470"></a>00470   <span class="keywordflow">else</span> {
<a name="l00471"></a>00471     ks-&gt;wrap_mode=kate_wrap_word;
<a name="l00472"></a>00472   }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   ret=kate_warp(kpb);
<a name="l00475"></a>00475   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   <span class="keywordflow">return</span> KMG_MERGE(parent_kmg);
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_styles_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482   KMG_GUARD();
<a name="l00483"></a>00483   <span class="keywordtype">int</span> ret,n,nstyles;
<a name="l00484"></a>00484   kate_style **styles;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   nstyles=kate_read32v(kpb);
<a name="l00489"></a>00489   <span class="keywordflow">if</span> (nstyles&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00490"></a>00490   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nstyles&gt;KATE_LIMIT_STYLES) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00491"></a>00491   styles=(kate_style**)KMG_CHECKED_MALLOC(nstyles,<span class="keyword">sizeof</span>(kate_style*));
<a name="l00492"></a>00492   <span class="keywordflow">if</span> (!styles) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00493"></a>00493   <span class="keywordflow">for</span> (n=0;n&lt;nstyles;++n) {
<a name="l00494"></a>00494     styles[n]=(kate_style*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_style));
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (!styles[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00496"></a>00496     ret=kate_decode_style(ki,styles[n],kpb,&amp;kmg);
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00498"></a>00498     <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00499"></a>00499   }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   ret=kate_warp(kpb);
<a name="l00502"></a>00502   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   ret=kate_check_eop(kpb);
<a name="l00505"></a>00505   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   ki-&gt;nstyles=nstyles;
<a name="l00508"></a>00508   ki-&gt;styles=styles;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   <span class="keywordflow">return</span> KMG_OK();
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_curve(<span class="keyword">const</span> kate_info *ki,kate_curve *kc,kate_pack_buffer *kpb,<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *parent_kmg)
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515   KMG_GUARD();
<a name="l00516"></a>00516   <span class="keywordtype">int</span> ret;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   <span class="keywordflow">if</span> (!ki || !kc || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520   kc-&gt;type=kate_pack_read(kpb,8);
<a name="l00521"></a>00521   kc-&gt;npts=kate_read32v(kpb);
<a name="l00522"></a>00522   ret=kate_warp(kpb);
<a name="l00523"></a>00523   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00524"></a>00524   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; kc-&gt;npts&gt;KATE_LIMIT_CURVE_POINTS) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00525"></a>00525   kc-&gt;pts=(kate_float*)KMG_CHECKED_MALLOC(kc-&gt;npts,2*<span class="keyword">sizeof</span>(kate_float));
<a name="l00526"></a>00526   <span class="keywordflow">if</span> (!kc-&gt;pts) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   ret=kate_fp_decode_kate_float(kc-&gt;npts,kc-&gt;pts,2,kpb);
<a name="l00529"></a>00529   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531   <span class="comment">/* on success, add our memory to the parent guard */</span>
<a name="l00532"></a>00532   <span class="keywordflow">return</span> KMG_MERGE(parent_kmg);
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_curves_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537   KMG_GUARD();
<a name="l00538"></a>00538   <span class="keywordtype">int</span> ret,n,ncurves;
<a name="l00539"></a>00539   kate_curve **curves=NULL;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543   ncurves=kate_read32v(kpb);
<a name="l00544"></a>00544   <span class="keywordflow">if</span> (ncurves&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00545"></a>00545   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; ncurves&gt;KATE_LIMIT_CURVES) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547   <span class="keywordflow">if</span> (ncurves&gt;0) {
<a name="l00548"></a>00548     curves=(kate_curve**)KMG_CHECKED_MALLOC(ncurves,<span class="keyword">sizeof</span>(kate_curve*));
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (!curves) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00550"></a>00550     <span class="keywordflow">for</span> (n=0;n&lt;ncurves;++n) {
<a name="l00551"></a>00551       curves[n]=(kate_curve*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_curve));
<a name="l00552"></a>00552       <span class="keywordflow">if</span> (!curves[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00553"></a>00553       ret=kate_decode_curve(ki,curves[n],kpb,&amp;kmg);
<a name="l00554"></a>00554       <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00555"></a>00555       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559   ret=kate_warp(kpb);
<a name="l00560"></a>00560   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562   ret=kate_check_eop(kpb);
<a name="l00563"></a>00563   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   ki-&gt;ncurves=ncurves;
<a name="l00566"></a>00566   ki-&gt;curves=curves;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568   <span class="keywordflow">return</span> KMG_OK();
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_motion(<span class="keyword">const</span> kate_info *ki,kate_motion *km,kate_pack_buffer *kpb,<a class="code" href="structkate__memory__guard.html">kate_memory_guard</a> *parent_kmg)
<a name="l00572"></a>00572 {
<a name="l00573"></a>00573   KMG_GUARD();
<a name="l00574"></a>00574   <span class="keywordtype">size_t</span> n;
<a name="l00575"></a>00575   <span class="keywordtype">int</span> ret;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   <span class="keywordflow">if</span> (!ki || !km || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579   km-&gt;ncurves=kate_read32v(kpb);
<a name="l00580"></a>00580   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; km-&gt;ncurves&gt;KATE_LIMIT_MOTION_CURVES) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00581"></a>00581   km-&gt;curves=(kate_curve**)KMG_CHECKED_MALLOC(km-&gt;ncurves,<span class="keyword">sizeof</span>(kate_curve*));
<a name="l00582"></a>00582   <span class="keywordflow">if</span> (!km-&gt;curves) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00583"></a>00583   km-&gt;durations=(kate_float*)KMG_CHECKED_MALLOC(km-&gt;ncurves,<span class="keyword">sizeof</span>(kate_float));
<a name="l00584"></a>00584   <span class="keywordflow">if</span> (!km-&gt;durations) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   <span class="keywordflow">for</span> (n=0;n&lt;km-&gt;ncurves;++n) {
<a name="l00587"></a>00587     <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l00588"></a>00588       <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l00589"></a>00589       <span class="keywordflow">if</span> (idx&gt;=ki-&gt;ncurves) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00590"></a>00590       km-&gt;curves[n]=ki-&gt;curves[idx];
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     <span class="keywordflow">else</span> {
<a name="l00593"></a>00593       km-&gt;curves[n]=(kate_curve*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_curve));
<a name="l00594"></a>00594       <span class="keywordflow">if</span> (!km-&gt;curves[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00595"></a>00595       ret=kate_decode_curve(ki,km-&gt;curves[n],kpb,&amp;kmg);
<a name="l00596"></a>00596       <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00597"></a>00597       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599   }
<a name="l00600"></a>00600   ret=kate_fp_decode_kate_float(km-&gt;ncurves,km-&gt;durations,1,kpb);
<a name="l00601"></a>00601   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00602"></a>00602   km-&gt;x_mapping=kate_pack_read(kpb,8);
<a name="l00603"></a>00603   km-&gt;y_mapping=kate_pack_read(kpb,8);
<a name="l00604"></a>00604   km-&gt;semantics=kate_pack_read(kpb,8);
<a name="l00605"></a>00605   km-&gt;periodic=kate_pack_read1(kpb);
<a name="l00606"></a>00606   ret=kate_warp(kpb);
<a name="l00607"></a>00607   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609   <span class="keywordflow">return</span> KMG_MERGE(parent_kmg);
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_motions_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00613"></a>00613 {
<a name="l00614"></a>00614   KMG_GUARD();
<a name="l00615"></a>00615   <span class="keywordtype">int</span> ret,n,nmotions;
<a name="l00616"></a>00616   kate_motion **motions=NULL;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   nmotions=kate_read32v(kpb);
<a name="l00621"></a>00621   <span class="keywordflow">if</span> (nmotions&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00622"></a>00622   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nmotions&gt;KATE_LIMIT_MOTIONS) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   <span class="keywordflow">if</span> (nmotions&gt;0) {
<a name="l00625"></a>00625     motions=(kate_motion**)KMG_CHECKED_MALLOC(nmotions,<span class="keyword">sizeof</span>(kate_motion*));
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (!motions) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00627"></a>00627     <span class="keywordflow">for</span> (n=0;n&lt;nmotions;++n) {
<a name="l00628"></a>00628       motions[n]=(kate_motion*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_motion));
<a name="l00629"></a>00629       <span class="keywordflow">if</span> (!motions[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00630"></a>00630       ret=kate_decode_motion(ki,motions[n],kpb,&amp;kmg);
<a name="l00631"></a>00631       <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00632"></a>00632       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634   }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636   ret=kate_warp(kpb);
<a name="l00637"></a>00637   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639   ret=kate_check_eop(kpb);
<a name="l00640"></a>00640   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   ki-&gt;nmotions=nmotions;
<a name="l00643"></a>00643   ki-&gt;motions=motions;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   <span class="keywordflow">return</span> KMG_OK();
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_palette(<span class="keyword">const</span> kate_info *ki,kate_palette *kp,kate_pack_buffer *kpb)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650   kate_color *colors;
<a name="l00651"></a>00651   <span class="keywordtype">size_t</span> n;
<a name="l00652"></a>00652   <span class="keywordtype">int</span> ret;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654   <span class="keywordflow">if</span> (!ki || !kp || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656   kp-&gt;ncolors=kate_pack_read(kpb,8)+1;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   colors=(kate_color*)kate_checked_malloc(kp-&gt;ncolors,<span class="keyword">sizeof</span>(kate_color));
<a name="l00659"></a>00659   <span class="keywordflow">if</span> (!colors) <span class="keywordflow">return</span> KATE_E_OUT_OF_MEMORY;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661   <span class="keywordflow">for</span> (n=0;n&lt;kp-&gt;ncolors;++n) {
<a name="l00662"></a>00662     ret=kate_decode_color(colors+n,kpb);
<a name="l00663"></a>00663     <span class="keywordflow">if</span> (kate_overread(kpb)) {
<a name="l00664"></a>00664       kate_free(colors);
<a name="l00665"></a>00665       <span class="keywordflow">return</span> ret;
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667     <span class="keywordflow">if</span> (ret&lt;0) {
<a name="l00668"></a>00668       kate_free(colors);
<a name="l00669"></a>00669       <span class="keywordflow">return</span> ret;
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671   }
<a name="l00672"></a>00672   ret=kate_warp(kpb);
<a name="l00673"></a>00673   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675   kp-&gt;colors=colors;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   <span class="keywordflow">return</span> 0;
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_palettes_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682   KMG_GUARD();
<a name="l00683"></a>00683   <span class="keywordtype">int</span> ret,n,npalettes;
<a name="l00684"></a>00684   kate_palette **palettes=NULL;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00687"></a>00687 
<a name="l00688"></a>00688   npalettes=kate_read32v(kpb);
<a name="l00689"></a>00689   <span class="keywordflow">if</span> (npalettes&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00690"></a>00690   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; npalettes&gt;KATE_LIMIT_PALETTES) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692   <span class="keywordflow">if</span> (npalettes&gt;0) {
<a name="l00693"></a>00693     palettes=(kate_palette**)KMG_CHECKED_MALLOC(npalettes,<span class="keyword">sizeof</span>(kate_palette*));
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (!palettes) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00695"></a>00695     <span class="keywordflow">for</span> (n=0;n&lt;npalettes;++n) {
<a name="l00696"></a>00696       palettes[n]=(kate_palette*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_palette));
<a name="l00697"></a>00697       <span class="keywordflow">if</span> (!palettes[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00698"></a>00698       ret=kate_decode_palette(ki,palettes[n],kpb);
<a name="l00699"></a>00699       <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00700"></a>00700       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702   }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   ret=kate_warp(kpb);
<a name="l00705"></a>00705   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   ret=kate_check_eop(kpb);
<a name="l00708"></a>00708   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   ki-&gt;npalettes=npalettes;
<a name="l00711"></a>00711   ki-&gt;palettes=palettes;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713   <span class="keywordflow">return</span> KMG_OK();
<a name="l00714"></a>00714 }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_bitmap(<span class="keyword">const</span> kate_info *ki,kate_bitmap *kb,kate_pack_buffer *kpb)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718   <span class="keywordtype">size_t</span> n,npixels;
<a name="l00719"></a>00719   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pixels;
<a name="l00720"></a>00720   <span class="keywordtype">int</span> ret,encoding;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722   <span class="keywordflow">if</span> (!ki || !kb || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724   kb-&gt;width=kate_read32v(kpb);
<a name="l00725"></a>00725   kb-&gt;height=kate_read32v(kpb);
<a name="l00726"></a>00726   kb-&gt;bpp=kate_pack_read(kpb,8);
<a name="l00727"></a>00727   <span class="keywordflow">if</span> (kb-&gt;width&lt;=0 || kb-&gt;height&lt;=0 || kb-&gt;bpp&gt;8) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00728"></a>00728   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; (kb-&gt;width&gt;KATE_LIMIT_BITMAP_SIZE || kb-&gt;height&gt;KATE_LIMIT_BITMAP_SIZE)) <span class="keywordflow">return</span> KATE_E_LIMIT;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730   <span class="keywordflow">if</span> (kb-&gt;bpp==0) {
<a name="l00731"></a>00731     <span class="comment">/* raw bitmap */</span>
<a name="l00732"></a>00732     kb-&gt;type=kate_pack_read(kpb,8);
<a name="l00733"></a>00733     kb-&gt;palette=-1;
<a name="l00734"></a>00734     <span class="keywordflow">switch</span> (kb-&gt;type) {
<a name="l00735"></a>00735       <span class="keywordflow">case</span> kate_bitmap_type_paletted:
<a name="l00736"></a>00736         encoding=kate_pack_read(kpb,8);
<a name="l00737"></a>00737         <span class="keywordflow">switch</span> (encoding) {
<a name="l00738"></a>00738           <span class="keywordflow">case</span> 1: <span class="comment">/* RLE encoded */</span>
<a name="l00739"></a>00739             kb-&gt;bpp=kate_read32v(kpb);
<a name="l00740"></a>00740             kb-&gt;palette=kate_read32v(kpb);
<a name="l00741"></a>00741             pixels=(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)kate_checked_malloc(kb-&gt;width,kb-&gt;height);
<a name="l00742"></a>00742             <span class="keywordflow">if</span> (!pixels) <span class="keywordflow">return</span> KATE_E_OUT_OF_MEMORY;
<a name="l00743"></a>00743             ret=kate_rle_decode(kb-&gt;width,kb-&gt;height,pixels,kb-&gt;bpp,kpb);
<a name="l00744"></a>00744             <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l00745"></a>00745             <span class="keywordflow">break</span>;
<a name="l00746"></a>00746           <span class="keywordflow">default</span>:
<a name="l00747"></a>00747             <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00748"></a>00748         }
<a name="l00749"></a>00749         <span class="keywordflow">break</span>;
<a name="l00750"></a>00750       <span class="keywordflow">case</span> kate_bitmap_type_png:
<a name="l00751"></a>00751         kb-&gt;size=kate_read32(kpb);
<a name="l00752"></a>00752         <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; kb-&gt;size&gt;KATE_LIMIT_BITMAP_RAW_SIZE) <span class="keywordflow">return</span> KATE_E_LIMIT;
<a name="l00753"></a>00753         pixels=(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)kate_malloc(kb-&gt;size);
<a name="l00754"></a>00754         <span class="keywordflow">if</span> (!pixels) <span class="keywordflow">return</span> KATE_E_OUT_OF_MEMORY;
<a name="l00755"></a>00755         ret=kate_readbuf(kpb,(<span class="keywordtype">char</span>*)pixels,kb-&gt;size);
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (ret&lt;0) {
<a name="l00757"></a>00757           kate_free(pixels);
<a name="l00758"></a>00758           <span class="keywordflow">return</span> ret;
<a name="l00759"></a>00759         }
<a name="l00760"></a>00760         <span class="keywordflow">break</span>;
<a name="l00761"></a>00761       <span class="keywordflow">default</span>:
<a name="l00762"></a>00762         <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764   }
<a name="l00765"></a>00765   <span class="keywordflow">else</span> {
<a name="l00766"></a>00766     <span class="comment">/* paletted bitmap */</span>
<a name="l00767"></a>00767     kb-&gt;type=kate_bitmap_type_paletted;
<a name="l00768"></a>00768     kb-&gt;palette=kate_read32v(kpb);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     ret=kate_check_mul_overflow(kb-&gt;width,kb-&gt;height,&amp;npixels);
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l00772"></a>00772     pixels=(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)kate_malloc(npixels);
<a name="l00773"></a>00773     <span class="keywordflow">if</span> (!pixels) <span class="keywordflow">return</span> KATE_E_OUT_OF_MEMORY;
<a name="l00774"></a>00774     <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)kate_pack_bits(kpb)&lt;npixels*kb-&gt;bpp) {
<a name="l00775"></a>00775       kate_free(pixels);
<a name="l00776"></a>00776       <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <span class="keywordflow">for</span> (n=0;n&lt;npixels;++n) {
<a name="l00780"></a>00780       pixels[n]=kate_pack_read(kpb,kb-&gt;bpp);
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (kate_overread(kpb)) {
<a name="l00783"></a>00783       kate_free(pixels);
<a name="l00784"></a>00784       <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786   }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788   <span class="keywordflow">if</span> (((ki-&gt;bitstream_version_major&lt;&lt;8)|ki-&gt;bitstream_version_minor)&gt;=0x0004) {
<a name="l00789"></a>00789     <span class="comment">/* 0.4 adds a warp for x/y offset */</span>
<a name="l00790"></a>00790     kate_read32v(kpb); <span class="comment">/* the size of the warp */</span>
<a name="l00791"></a>00791     kb-&gt;x_offset=kate_read32v(kpb);
<a name="l00792"></a>00792     kb-&gt;y_offset=kate_read32v(kpb);
<a name="l00793"></a>00793   }
<a name="l00794"></a>00794   <span class="keywordflow">else</span> {
<a name="l00795"></a>00795     kb-&gt;x_offset=0;
<a name="l00796"></a>00796     kb-&gt;y_offset=0;
<a name="l00797"></a>00797   }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   ret=kate_warp(kpb);
<a name="l00800"></a>00800   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802   kb-&gt;pixels=pixels;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804   <span class="keywordflow">return</span> 0;
<a name="l00805"></a>00805 }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_bitmaps_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00808"></a>00808 {
<a name="l00809"></a>00809   KMG_GUARD();
<a name="l00810"></a>00810   <span class="keywordtype">int</span> ret,n,nbitmaps;
<a name="l00811"></a>00811   kate_bitmap **bitmaps=NULL;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   nbitmaps=kate_read32v(kpb);
<a name="l00816"></a>00816   <span class="keywordflow">if</span> (nbitmaps&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00817"></a>00817   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nbitmaps&gt;KATE_LIMIT_BITMAPS) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   <span class="keywordflow">if</span> (nbitmaps&gt;0) {
<a name="l00820"></a>00820     bitmaps=(kate_bitmap**)KMG_CHECKED_MALLOC(nbitmaps,<span class="keyword">sizeof</span>(kate_bitmap*));
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (!bitmaps) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00822"></a>00822     <span class="keywordflow">for</span> (n=0;n&lt;nbitmaps;++n) {
<a name="l00823"></a>00823       bitmaps[n]=(kate_bitmap*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_bitmap));
<a name="l00824"></a>00824       <span class="keywordflow">if</span> (!bitmaps[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00825"></a>00825       ret=kate_decode_bitmap(ki,bitmaps[n],kpb);
<a name="l00826"></a>00826       <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00827"></a>00827       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829   }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831   ret=kate_warp(kpb);
<a name="l00832"></a>00832   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   ret=kate_check_eop(kpb);
<a name="l00835"></a>00835   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837   ki-&gt;nbitmaps=nbitmaps;
<a name="l00838"></a>00838   ki-&gt;bitmaps=bitmaps;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840   <span class="keywordflow">return</span> KMG_OK();
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_font_range(<span class="keyword">const</span> kate_info *ki,kate_font_range *kfr,kate_pack_buffer *kpb)
<a name="l00844"></a>00844 {
<a name="l00845"></a>00845   <span class="keywordflow">if</span> (!ki || !kfr || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847   kfr-&gt;first_code_point=kate_read32v(kpb);
<a name="l00848"></a>00848   kfr-&gt;last_code_point=kate_read32v(kpb);
<a name="l00849"></a>00849   kfr-&gt;first_bitmap=kate_read32v(kpb);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851   <span class="keywordflow">return</span> kate_warp(kpb);
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_font_ranges_packet(kate_info *ki,kate_pack_buffer *kpb)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856   KMG_GUARD();
<a name="l00857"></a>00857   <span class="keywordtype">int</span> l,n,ret;
<a name="l00858"></a>00858   <span class="keywordtype">int</span> nfont_ranges,nfont_mappings;
<a name="l00859"></a>00859   kate_font_range **font_ranges=NULL;
<a name="l00860"></a>00860   kate_font_mapping **font_mappings=NULL;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862   <span class="keywordflow">if</span> (!ki || !kpb) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_INVALID_PARAMETER);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864   nfont_ranges=kate_read32v(kpb);
<a name="l00865"></a>00865   <span class="keywordflow">if</span> (nfont_ranges&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00866"></a>00866   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nfont_ranges&gt;KATE_LIMIT_FONT_RANGES) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868   <span class="keywordflow">if</span> (nfont_ranges&gt;0) {
<a name="l00869"></a>00869     font_ranges=(kate_font_range**)KMG_CHECKED_MALLOC(nfont_ranges,<span class="keyword">sizeof</span>(kate_font_range*));
<a name="l00870"></a>00870     <span class="keywordflow">if</span> (!font_ranges) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00871"></a>00871     <span class="keywordflow">for</span> (n=0;n&lt;nfont_ranges;++n) {
<a name="l00872"></a>00872       font_ranges[n]=(kate_font_range*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_font_range));
<a name="l00873"></a>00873       <span class="keywordflow">if</span> (!font_ranges[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00874"></a>00874       ret=kate_decode_font_range(ki,font_ranges[n],kpb);
<a name="l00875"></a>00875       <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00876"></a>00876       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00877"></a>00877     }
<a name="l00878"></a>00878   }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880   <span class="comment">/* these may now be used by the mappings */</span>
<a name="l00881"></a>00881   ki-&gt;nfont_ranges=nfont_ranges;
<a name="l00882"></a>00882   ki-&gt;font_ranges=font_ranges;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884   <span class="comment">/* now, the mappings */</span>
<a name="l00885"></a>00885   nfont_mappings=kate_read32v(kpb);
<a name="l00886"></a>00886   <span class="keywordflow">if</span> (nfont_mappings&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00887"></a>00887   <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nfont_mappings&gt;KATE_LIMIT_FONT_MAPPINGS) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889   <span class="keywordflow">if</span> (nfont_mappings&gt;0) {
<a name="l00890"></a>00890     font_mappings=(kate_font_mapping**)KMG_CHECKED_MALLOC(nfont_mappings,<span class="keyword">sizeof</span>(kate_font_mapping*));
<a name="l00891"></a>00891     <span class="keywordflow">if</span> (!font_mappings) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00892"></a>00892     <span class="keywordflow">for</span> (n=0;n&lt;nfont_mappings;++n) {
<a name="l00893"></a>00893       font_mappings[n]=(kate_font_mapping*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_font_mapping));
<a name="l00894"></a>00894       <span class="keywordflow">if</span> (!font_mappings[n]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896       nfont_ranges=kate_read32v(kpb);
<a name="l00897"></a>00897       <span class="keywordflow">if</span> (nfont_ranges&lt;0) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00898"></a>00898       <span class="keywordflow">if</span> (!ki-&gt;no_limits &amp;&amp; nfont_ranges&gt;KATE_LIMIT_FONT_MAPPING_RANGES) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_LIMIT);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900       <span class="keywordflow">if</span> (nfont_ranges&gt;0) {
<a name="l00901"></a>00901         font_ranges=(kate_font_range**)KMG_CHECKED_MALLOC(nfont_ranges,<span class="keyword">sizeof</span>(kate_font_range*));
<a name="l00902"></a>00902         <span class="keywordflow">if</span> (!font_ranges) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904         <span class="keywordflow">for</span> (l=0;l&lt;nfont_ranges;++l) {
<a name="l00905"></a>00905           <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l00906"></a>00906             <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l00907"></a>00907             <span class="keywordflow">if</span> (idx&gt;=ki-&gt;nfont_ranges) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00908"></a>00908             font_ranges[l]=ki-&gt;font_ranges[idx];
<a name="l00909"></a>00909           }
<a name="l00910"></a>00910           <span class="keywordflow">else</span> {
<a name="l00911"></a>00911             font_ranges[l]=(kate_font_range*)KMG_MALLOC(<span class="keyword">sizeof</span>(kate_font_range));
<a name="l00912"></a>00912             <span class="keywordflow">if</span> (!font_ranges[l]) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_OUT_OF_MEMORY);
<a name="l00913"></a>00913             ret=kate_decode_font_range(ki,font_ranges[l],kpb);
<a name="l00914"></a>00914             <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">return</span> KMG_ERROR(KATE_E_BAD_PACKET);
<a name="l00915"></a>00915             <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00916"></a>00916           }
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918         font_mappings[n]-&gt;nranges=nfont_ranges;
<a name="l00919"></a>00919         font_mappings[n]-&gt;ranges=font_ranges;
<a name="l00920"></a>00920       }
<a name="l00921"></a>00921       <span class="keywordflow">else</span> {
<a name="l00922"></a>00922         font_mappings[n]-&gt;nranges=0;
<a name="l00923"></a>00923         font_mappings[n]-&gt;ranges=NULL;
<a name="l00924"></a>00924       }
<a name="l00925"></a>00925     }
<a name="l00926"></a>00926   }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928   ret=kate_warp(kpb);
<a name="l00929"></a>00929   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00930"></a>00930 
<a name="l00931"></a>00931   ret=kate_check_eop(kpb);
<a name="l00932"></a>00932   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934   ki-&gt;nfont_mappings=nfont_mappings;
<a name="l00935"></a>00935   ki-&gt;font_mappings=font_mappings;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937   <span class="keywordflow">return</span> KMG_OK();
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00951"></a>00951 <span class="keywordtype">int</span> kate_decode_headerin(kate_info *ki,kate_comment *kc,kate_packet *kp)
<a name="l00952"></a>00952 {
<a name="l00953"></a>00953   kate_pack_buffer kpb;
<a name="l00954"></a>00954   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> headerid;
<a name="l00955"></a>00955   <span class="keywordtype">int</span> ret;
<a name="l00956"></a>00956   <span class="keywordtype">int</span> packetno;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958   <span class="keywordflow">if</span> (!ki || !kc || !kp) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960   kate_pack_readinit(&amp;kpb,kp-&gt;data,kp-&gt;nbytes);
<a name="l00961"></a>00961   headerid=kate_pack_read(&amp;kpb,8);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963   ret=kate_decode_check_magic(&amp;kpb);
<a name="l00964"></a>00964   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966   <span class="keywordflow">if</span> (!(headerid&amp;0x80)) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00967"></a>00967   packetno=headerid&amp;~0x80;
<a name="l00968"></a>00968   <span class="keywordflow">if</span> (packetno&lt;ki-&gt;num_headers) {
<a name="l00969"></a>00969     <span class="keywordflow">if</span> (ki-&gt;probe!=packetno) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00970"></a>00970   }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972   <span class="comment">/* starting with 0.1.4 (bitstream version 0.2, unchanged), there</span>
<a name="l00973"></a>00973 <span class="comment">     was a change in the interpretation of the Kate magic, at the</span>
<a name="l00974"></a>00974 <span class="comment">     request of Xiph, to limit signature length to 8 bytes. So the</span>
<a name="l00975"></a>00975 <span class="comment">     signature (from byte offset 1, after the packet type byte) is</span>
<a name="l00976"></a>00976 <span class="comment">     now only 7 bytes rather than 8, but all headers packets have</span>
<a name="l00977"></a>00977 <span class="comment">     a reserved 0 byte after the signature, so the actual bitstream</span>
<a name="l00978"></a>00978 <span class="comment">     format is left unchanged */</span>
<a name="l00979"></a>00979   <span class="keywordflow">if</span> (kate_pack_read(&amp;kpb,8)!=0) <span class="keywordflow">return</span> KATE_E_BAD_PACKET;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981   <span class="keywordflow">switch</span> (packetno) {
<a name="l00982"></a>00982     <span class="keywordflow">case</span> 0: <span class="comment">/* this is the info packet */</span>
<a name="l00983"></a>00983       ret=kate_decode_info_header(ki,&amp;kpb);
<a name="l00984"></a>00984       <span class="keywordflow">break</span>;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986     <span class="keywordflow">case</span> 1: <span class="comment">/* this is the comments packet */</span>
<a name="l00987"></a>00987       ret=kate_decode_comment_packet(ki,kc,&amp;kpb);
<a name="l00988"></a>00988       <span class="keywordflow">break</span>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <span class="keywordflow">case</span> 2: <span class="comment">/* this is the region list packet */</span>
<a name="l00991"></a>00991       ret=kate_decode_regions_packet(ki,&amp;kpb);
<a name="l00992"></a>00992       <span class="keywordflow">break</span>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     <span class="keywordflow">case</span> 3: <span class="comment">/* this is the style list packet */</span>
<a name="l00995"></a>00995       ret=kate_decode_styles_packet(ki,&amp;kpb);
<a name="l00996"></a>00996       <span class="keywordflow">break</span>;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     <span class="keywordflow">case</span> 4: <span class="comment">/* this is the curve list packet */</span>
<a name="l00999"></a>00999       ret=kate_decode_curves_packet(ki,&amp;kpb);
<a name="l01000"></a>01000       <span class="keywordflow">break</span>;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002     <span class="keywordflow">case</span> 5: <span class="comment">/* this is the motion list packet */</span>
<a name="l01003"></a>01003       ret=kate_decode_motions_packet(ki,&amp;kpb);
<a name="l01004"></a>01004       <span class="keywordflow">break</span>;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     <span class="keywordflow">case</span> 6: <span class="comment">/* this is the palette list packet */</span>
<a name="l01007"></a>01007       ret=kate_decode_palettes_packet(ki,&amp;kpb);
<a name="l01008"></a>01008       <span class="keywordflow">break</span>;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010     <span class="keywordflow">case</span> 7: <span class="comment">/* this is the bitmap list packet */</span>
<a name="l01011"></a>01011       ret=kate_decode_bitmaps_packet(ki,&amp;kpb);
<a name="l01012"></a>01012       <span class="keywordflow">break</span>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="keywordflow">case</span> 8: <span class="comment">/* this is the font ranges list packet */</span>
<a name="l01015"></a>01015       ret=kate_decode_font_ranges_packet(ki,&amp;kpb);
<a name="l01016"></a>01016       <span class="keywordflow">if</span> (ret==0) ret=1; <span class="comment">/* we&apos;re done, we know of no more headers to come */</span>
<a name="l01017"></a>01017       <span class="keywordflow">break</span>;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     <span class="keywordflow">default</span>:
<a name="l01020"></a>01020       <span class="comment">/* we ignore extra header packets for future proofing */</span>
<a name="l01021"></a>01021       ret=0;
<a name="l01022"></a>01022       <span class="keywordflow">break</span>;
<a name="l01023"></a>01023   }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   <span class="keywordflow">if</span> (ret&gt;=0) {
<a name="l01026"></a>01026     <span class="comment">/* if the header was parsed successfully, we&apos;re ready for the next one */</span>
<a name="l01027"></a>01027     ki-&gt;probe++;
<a name="l01028"></a>01028   }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030   <span class="keywordflow">return</span> ret;
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 
<a name="l01042"></a>01042 <span class="keywordtype">int</span> kate_decode_init(kate_state *k,kate_info *ki)
<a name="l01043"></a>01043 {
<a name="l01044"></a>01044   <span class="keywordflow">if</span> (!k || !ki) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046   k-&gt;ki=ki;
<a name="l01047"></a>01047   k-&gt;kes=NULL;
<a name="l01048"></a>01048   k-&gt;kds=kate_decode_state_create();
<a name="l01049"></a>01049   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_OUT_OF_MEMORY;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051   <span class="keywordflow">return</span> 0;
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054 <span class="preprocessor">#define READ_OVERRIDE(read) \</span>
<a name="l01055"></a>01055 <span class="preprocessor">  do { \</span>
<a name="l01056"></a>01056 <span class="preprocessor">    if (kate_pack_read1(kpb)) { read; } \</span>
<a name="l01057"></a>01057 <span class="preprocessor">  } while(0)</span>
<a name="l01058"></a>01058 <span class="preprocessor"></span>
<a name="l01059"></a>01059 <span class="preprocessor">#if 0 &amp;&amp; defined DEBUG</span>
<a name="l01060"></a>01060 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l01061"></a>01061 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l01062"></a>01062 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l01063"></a>01063 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l01064"></a>01064 <span class="preprocessor">#define RNDERR(label) \</span>
<a name="l01065"></a>01065 <span class="preprocessor">  do { \</span>
<a name="l01066"></a>01066 <span class="preprocessor">    static int seed=0; \</span>
<a name="l01067"></a>01067 <span class="preprocessor">    if (!seed) { \</span>
<a name="l01068"></a>01068 <span class="preprocessor">      const char *env=getenv(&quot;KATE_RAND_SEED&quot;); \</span>
<a name="l01069"></a>01069 <span class="preprocessor">      if (env) srand(atoi(env)); else srand(time(NULL)^getpid()); \</span>
<a name="l01070"></a>01070 <span class="preprocessor">      seed=1; \</span>
<a name="l01071"></a>01071 <span class="preprocessor">    } \</span>
<a name="l01072"></a>01072 <span class="preprocessor">    if (((rand()&gt;&gt;8)&amp;0xff)==0) { \</span>
<a name="l01073"></a>01073 <span class="preprocessor">      ret=KATE_E_OUT_OF_MEMORY; \</span>
<a name="l01074"></a>01074 <span class="preprocessor">      goto label; \</span>
<a name="l01075"></a>01075 <span class="preprocessor">    } \</span>
<a name="l01076"></a>01076 <span class="preprocessor">  } while(0)</span>
<a name="l01077"></a>01077 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span><span class="preprocessor">#define RNDERR(label) ((void)0)</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span>
<a name="l01081"></a>01081 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_text_packet(kate_state *k,kate_pack_buffer *kpb,<span class="keywordtype">int</span> repeat)
<a name="l01082"></a>01082 {
<a name="l01083"></a>01083   KMG_GUARD();
<a name="l01084"></a>01084   <span class="keywordtype">int</span> ret,n;
<a name="l01085"></a>01085   <span class="keywordtype">int</span> len;
<a name="l01086"></a>01086   <span class="keywordtype">char</span> *text;
<a name="l01087"></a>01087   kate_decode_state *kds;
<a name="l01088"></a>01088   kate_event *ev;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090   <span class="keywordflow">if</span> (!k || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01091"></a>01091   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093   ret=kate_decode_state_clear(k-&gt;kds,k-&gt;ki,1);
<a name="l01094"></a>01094   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096   kds=k-&gt;kds;
<a name="l01097"></a>01097   ev=kds-&gt;event;
<a name="l01098"></a>01098 
<a name="l01099"></a>01099   ev-&gt;start=kate_read64(kpb);
<a name="l01100"></a>01100   ev-&gt;duration=kate_read64(kpb);
<a name="l01101"></a>01101   ev-&gt;backlink=kate_read64(kpb);
<a name="l01102"></a>01102   <span class="keywordflow">if</span> (ev-&gt;start&lt;0 || ev-&gt;duration&lt;0) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01103"></a>01103   <span class="keywordflow">if</span> (ev-&gt;backlink&lt;0 || ev-&gt;backlink&gt;ev-&gt;start) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01104"></a>01104   RNDERR(error_bad_packet);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106   ev-&gt;start_time=kate_granule_duration(k-&gt;ki,ev-&gt;start);
<a name="l01107"></a>01107   ev-&gt;end_time=ev-&gt;start_time+kate_granule_duration(k-&gt;ki,ev-&gt;duration);
<a name="l01108"></a>01108 
<a name="l01109"></a>01109   len=kate_read32(kpb);
<a name="l01110"></a>01110   <span class="keywordflow">if</span> (len&lt;0) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01111"></a>01111   RNDERR(error_bad_packet);
<a name="l01112"></a>01112   <span class="keywordflow">if</span> (!k-&gt;ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_TEXT_LENGTH) <span class="keywordflow">goto</span> error_limit;
<a name="l01113"></a>01113   RNDERR(error_limit);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115   <span class="comment">/* read the text, and null terminate it - 4 characters for UTF-32 */</span>
<a name="l01116"></a>01116   <span class="keywordflow">if</span> (kate_check_add_overflow(len,4,NULL)) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01117"></a>01117   text=(<span class="keywordtype">char</span>*)KMG_MALLOC(len+4);
<a name="l01118"></a>01118   <span class="keywordflow">if</span> (!text) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01119"></a>01119   RNDERR(error_out_of_memory);
<a name="l01120"></a>01120   ret=kate_readbuf(kpb,text,len);
<a name="l01121"></a>01121   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01122"></a>01122   text[len]=0;
<a name="l01123"></a>01123   text[len+1]=0;
<a name="l01124"></a>01124   text[len+2]=0;
<a name="l01125"></a>01125   text[len+3]=0;
<a name="l01126"></a>01126   <span class="comment">/* we can&apos;t validate the text yet, as we don&apos;t know whether there&apos;s a text encoding override later,</span>
<a name="l01127"></a>01127 <span class="comment">     so we delay validatation till we&apos;ve read the overrides */</span>
<a name="l01128"></a>01128 
<a name="l01129"></a>01129   ev-&gt;text=text;
<a name="l01130"></a>01130   ev-&gt;len=len;
<a name="l01131"></a>01131   ev-&gt;len0=len+4;
<a name="l01132"></a>01132 
<a name="l01133"></a>01133   <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l01134"></a>01134     ev-&gt;id=kate_read32v(kpb);
<a name="l01135"></a>01135   }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137   <span class="keywordflow">if</span> (repeat &amp;&amp; ev-&gt;id&gt;=0) {
<a name="l01138"></a>01138     <span class="comment">/* if this is a repeat, check if we have this event already */</span>
<a name="l01139"></a>01139     ret=kate_decode_state_find_event(k-&gt;kds,ev-&gt;id);
<a name="l01140"></a>01140     <span class="keywordflow">if</span> (ret&lt;0 &amp;&amp; ret!=KATE_E_NOT_FOUND) <span class="keywordflow">goto</span> error;
<a name="l01141"></a>01141     <span class="keywordflow">if</span> (ret&gt;=0) <span class="keywordflow">goto</span> ignore;
<a name="l01142"></a>01142   }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144   <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l01145"></a>01145     kate_motion **motions=NULL;
<a name="l01146"></a>01146     <span class="keywordtype">size_t</span> nmotions=0;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     len=kate_read32v(kpb);
<a name="l01149"></a>01149     <span class="keywordflow">if</span> (len&lt;=0) <span class="keywordflow">goto</span> error_bad_packet; <span class="comment">/* if the flag was set, there&apos;s at least one */</span>
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (!k-&gt;ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_TEXT_MOTIONS) <span class="keywordflow">goto</span> error_limit;
<a name="l01151"></a>01151     RNDERR(error_limit);
<a name="l01152"></a>01152     motions=(kate_motion**)KMG_CHECKED_MALLOC(len,<span class="keyword">sizeof</span>(kate_motion*));
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (!motions) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01154"></a>01154     RNDERR(error_out_of_memory);
<a name="l01155"></a>01155     nmotions=0;
<a name="l01156"></a>01156     <span class="keywordflow">for</span> (n=0;n&lt;len;++n) {
<a name="l01157"></a>01157       <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l01158"></a>01158         <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01159"></a>01159         <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nmotions) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01160"></a>01160         RNDERR(error_bad_packet);
<a name="l01161"></a>01161         motions[n]=k-&gt;ki-&gt;motions[idx];
<a name="l01162"></a>01162       }
<a name="l01163"></a>01163       <span class="keywordflow">else</span> {
<a name="l01164"></a>01164         motions[n]=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_motion));
<a name="l01165"></a>01165         <span class="keywordflow">if</span> (!motions[n]) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01166"></a>01166         RNDERR(error_out_of_memory);
<a name="l01167"></a>01167         ret=kate_decode_motion(k-&gt;ki,motions[n],kpb,&amp;kmg);
<a name="l01168"></a>01168         <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01169"></a>01169         <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01170"></a>01170         RNDERR(error);
<a name="l01171"></a>01171       }
<a name="l01172"></a>01172       ++nmotions;
<a name="l01173"></a>01173     }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     ev-&gt;motions=motions;
<a name="l01176"></a>01176     ev-&gt;nmotions=nmotions;
<a name="l01177"></a>01177   }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179   <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l01180"></a>01180     READ_OVERRIDE(ev-&gt;text_encoding=kate_pack_read(kpb,8));
<a name="l01181"></a>01181     READ_OVERRIDE(ev-&gt;text_directionality=kate_pack_read(kpb,8));
<a name="l01182"></a>01182     READ_OVERRIDE(
<a name="l01183"></a>01183       <span class="keywordflow">do</span> {
<a name="l01184"></a>01184         len=kate_read32v(kpb);
<a name="l01185"></a>01185         <span class="keywordflow">if</span> (len&lt;0) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01186"></a>01186         RNDERR(error_bad_packet);
<a name="l01187"></a>01187         <span class="keywordflow">if</span> (!k-&gt;ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_LANGUAGE_LENGTH) <span class="keywordflow">goto</span> error_limit;
<a name="l01188"></a>01188         RNDERR(error_limit);
<a name="l01189"></a>01189         <span class="keywordflow">if</span> (len&gt;0) {
<a name="l01190"></a>01190           ev-&gt;language=(<span class="keywordtype">char</span>*)KMG_MALLOC(len+1);
<a name="l01191"></a>01191           <span class="keywordflow">if</span> (!ev-&gt;language) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01192"></a>01192         RNDERR(error_out_of_memory);
<a name="l01193"></a>01193           ret=kate_readbuf(kpb,ev-&gt;language,len);
<a name="l01194"></a>01194           <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01195"></a>01195           ev-&gt;language[len]=0;
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197       } <span class="keywordflow">while</span>(0)
<a name="l01198"></a>01198     );
<a name="l01199"></a>01199     READ_OVERRIDE(
<a name="l01200"></a>01200       <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01201"></a>01201       <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nregions) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01202"></a>01202       RNDERR(error_bad_packet);
<a name="l01203"></a>01203       ev-&gt;region=k-&gt;ki-&gt;regions[idx];
<a name="l01204"></a>01204     );
<a name="l01205"></a>01205     READ_OVERRIDE(
<a name="l01206"></a>01206       ev-&gt;region=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_region));
<a name="l01207"></a>01207       <span class="keywordflow">if</span> (!ev-&gt;region) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01208"></a>01208       RNDERR(error_out_of_memory);
<a name="l01209"></a>01209       ret=kate_decode_region(k-&gt;ki,ev-&gt;region,kpb);
<a name="l01210"></a>01210       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01211"></a>01211     );
<a name="l01212"></a>01212     READ_OVERRIDE(
<a name="l01213"></a>01213       <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01214"></a>01214       <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nstyles) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01215"></a>01215       RNDERR(error_bad_packet);
<a name="l01216"></a>01216       ev-&gt;style=k-&gt;ki-&gt;styles[idx]
<a name="l01217"></a>01217     );
<a name="l01218"></a>01218     READ_OVERRIDE(
<a name="l01219"></a>01219       ev-&gt;style=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_style));
<a name="l01220"></a>01220       <span class="keywordflow">if</span> (!ev-&gt;style) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01221"></a>01221       RNDERR(error_out_of_memory);
<a name="l01222"></a>01222       ret=kate_decode_style(k-&gt;ki,ev-&gt;style,kpb,&amp;kmg);
<a name="l01223"></a>01223       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01224"></a>01224     );
<a name="l01225"></a>01225     READ_OVERRIDE(
<a name="l01226"></a>01226       <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01227"></a>01227       <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nstyles) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01228"></a>01228       RNDERR(error_bad_packet);
<a name="l01229"></a>01229       ev-&gt;secondary_style=k-&gt;ki-&gt;styles[idx]
<a name="l01230"></a>01230     );
<a name="l01231"></a>01231     READ_OVERRIDE(
<a name="l01232"></a>01232       ev-&gt;secondary_style=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_style));
<a name="l01233"></a>01233       <span class="keywordflow">if</span> (!ev-&gt;secondary_style) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01234"></a>01234       RNDERR(error_out_of_memory);
<a name="l01235"></a>01235       ret=kate_decode_style(k-&gt;ki,ev-&gt;secondary_style,kpb,&amp;kmg);
<a name="l01236"></a>01236       <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01237"></a>01237       RNDERR(error);
<a name="l01238"></a>01238     );
<a name="l01239"></a>01239     READ_OVERRIDE(
<a name="l01240"></a>01240       <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01241"></a>01241       <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nfont_mappings) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01242"></a>01242       RNDERR(error_bad_packet);
<a name="l01243"></a>01243       ev-&gt;font_mapping=k-&gt;ki-&gt;font_mappings[idx]
<a name="l01244"></a>01244     );
<a name="l01245"></a>01245   }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247   <span class="keywordflow">if</span> (((k-&gt;ki-&gt;bitstream_version_major&lt;&lt;8)|k-&gt;ki-&gt;bitstream_version_minor)&gt;=0x0002) {
<a name="l01248"></a>01248     <span class="comment">/* 0.2 adds a warp for palette, bitmap, markup type */</span>
<a name="l01249"></a>01249     kate_read32v(kpb); <span class="comment">/* the size of the warp */</span>
<a name="l01250"></a>01250     <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l01251"></a>01251       READ_OVERRIDE(
<a name="l01252"></a>01252         <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01253"></a>01253         <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;npalettes) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01254"></a>01254         RNDERR(error_bad_packet);
<a name="l01255"></a>01255         ev-&gt;palette=k-&gt;ki-&gt;palettes[idx];
<a name="l01256"></a>01256       );
<a name="l01257"></a>01257       READ_OVERRIDE(
<a name="l01258"></a>01258         ev-&gt;palette=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_palette));
<a name="l01259"></a>01259         <span class="keywordflow">if</span> (!ev-&gt;palette) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01260"></a>01260         ret=kate_decode_palette(k-&gt;ki,ev-&gt;palette,kpb);
<a name="l01261"></a>01261         if (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01262"></a>01262         RNDERR(error);
<a name="l01263"></a>01263       );
<a name="l01264"></a>01264       READ_OVERRIDE(
<a name="l01265"></a>01265         <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01266"></a>01266         <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nbitmaps) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01267"></a>01267         ev-&gt;bitmap=k-&gt;ki-&gt;bitmaps[idx];
<a name="l01268"></a>01268       );
<a name="l01269"></a>01269       READ_OVERRIDE(
<a name="l01270"></a>01270         ev-&gt;bitmap=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_bitmap));
<a name="l01271"></a>01271         <span class="keywordflow">if</span> (!ev-&gt;bitmap) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01272"></a>01272         RNDERR(error_out_of_memory);
<a name="l01273"></a>01273         ret=kate_decode_bitmap(k-&gt;ki,ev-&gt;bitmap,kpb);
<a name="l01274"></a>01274         <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01275"></a>01275         RNDERR(error);
<a name="l01276"></a>01276       );
<a name="l01277"></a>01277       READ_OVERRIDE(ev-&gt;text_markup_type=kate_pack_read(kpb,8));
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279   }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281   <span class="keywordflow">if</span> (((k-&gt;ki-&gt;bitstream_version_major&lt;&lt;8)|k-&gt;ki-&gt;bitstream_version_minor)&gt;=0x0004) {
<a name="l01282"></a>01282     <span class="comment">/* 0.4 adds a warp for bitmaps */</span>
<a name="l01283"></a>01283     kate_bitmap **bitmaps=NULL;
<a name="l01284"></a>01284     <span class="keywordtype">size_t</span> nbitmaps=0;
<a name="l01285"></a>01285 
<a name="l01286"></a>01286     kate_read32v(kpb); <span class="comment">/* the size of the warp */</span>
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     len=kate_read32v(kpb);
<a name="l01289"></a>01289     <span class="keywordflow">if</span> (len&lt;0) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01290"></a>01290     RNDERR(error_bad_packet);
<a name="l01291"></a>01291     <span class="keywordflow">if</span> (len&gt;0) {
<a name="l01292"></a>01292       <span class="keywordflow">if</span> (!k-&gt;ki-&gt;no_limits &amp;&amp; len&gt;KATE_LIMIT_BITMAPS) <span class="keywordflow">goto</span> error_limit;
<a name="l01293"></a>01293       bitmaps=(kate_bitmap**)KMG_CHECKED_MALLOC(len,<span class="keyword">sizeof</span>(kate_bitmap*));
<a name="l01294"></a>01294       <span class="keywordflow">if</span> (!bitmaps) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01295"></a>01295       RNDERR(error_out_of_memory);
<a name="l01296"></a>01296       nbitmaps=0;
<a name="l01297"></a>01297       <span class="keywordflow">for</span> (n=0;n&lt;len;++n) {
<a name="l01298"></a>01298         <span class="keywordflow">if</span> (kate_pack_read1(kpb)) {
<a name="l01299"></a>01299           <span class="keywordtype">size_t</span> idx=kate_read32v(kpb);
<a name="l01300"></a>01300           <span class="keywordflow">if</span> (idx&gt;=k-&gt;ki-&gt;nbitmaps) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01301"></a>01301           RNDERR(error_bad_packet);
<a name="l01302"></a>01302           bitmaps[n]=k-&gt;ki-&gt;bitmaps[idx];
<a name="l01303"></a>01303         }
<a name="l01304"></a>01304         <span class="keywordflow">else</span> {
<a name="l01305"></a>01305           bitmaps[n]=KMG_MALLOC(<span class="keyword">sizeof</span>(kate_bitmap));
<a name="l01306"></a>01306           <span class="keywordflow">if</span> (!bitmaps[n]) <span class="keywordflow">goto</span> error_out_of_memory;
<a name="l01307"></a>01307           RNDERR(error_out_of_memory);
<a name="l01308"></a>01308           ret=kate_decode_bitmap(k-&gt;ki,bitmaps[n],kpb);
<a name="l01309"></a>01309           <span class="keywordflow">if</span> (kate_overread(kpb)) <span class="keywordflow">goto</span> error_bad_packet;
<a name="l01310"></a>01310           <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01311"></a>01311         }
<a name="l01312"></a>01312         ++nbitmaps;
<a name="l01313"></a>01313       }
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     ev-&gt;bitmaps=bitmaps;
<a name="l01317"></a>01317     ev-&gt;nbitmaps=nbitmaps;
<a name="l01318"></a>01318   }
<a name="l01319"></a>01319   <span class="keywordflow">else</span> {
<a name="l01320"></a>01320     ev-&gt;bitmaps=NULL;
<a name="l01321"></a>01321     ev-&gt;nbitmaps=0;
<a name="l01322"></a>01322   }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   ret=kate_warp(kpb);
<a name="l01325"></a>01325   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01326"></a>01326   RNDERR(error);
<a name="l01327"></a>01327 
<a name="l01328"></a>01328   <span class="comment">/* validate text, and reject invalid encodings */</span>
<a name="l01329"></a>01329   ret=kate_text_validate(ev-&gt;text_encoding,ev-&gt;text,ev-&gt;len0);
<a name="l01330"></a>01330   RNDERR(error);
<a name="l01331"></a>01331   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01332"></a>01332 
<a name="l01333"></a>01333   <span class="keywordflow">if</span> (ev-&gt;text_markup_type!=kate_markup_none &amp;&amp; k-&gt;ki-&gt;remove_markup) {
<a name="l01334"></a>01334     <span class="keywordtype">size_t</span> zero_size=ev-&gt;len0-ev-&gt;len;
<a name="l01335"></a>01335     ret=kate_text_remove_markup(ev-&gt;text_encoding,ev-&gt;text,&amp;ev-&gt;len0);
<a name="l01336"></a>01336     <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01337"></a>01337     <span class="keywordflow">if</span> (ev-&gt;len0&lt;zero_size) <span class="keywordflow">goto</span> error_bad_packet; <span class="comment">/* can&apos;t happen, but let&apos;s be safe */</span>
<a name="l01338"></a>01338     ev-&gt;len=ev-&gt;len0-zero_size;
<a name="l01339"></a>01339     RNDERR(error);
<a name="l01340"></a>01340     ev-&gt;text_markup_type=kate_markup_none;
<a name="l01341"></a>01341   }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343   <span class="comment">/* if no style, use the region (if any) default style */</span>
<a name="l01344"></a>01344   <span class="keywordflow">if</span> (!ev-&gt;style &amp;&amp; ev-&gt;region) {
<a name="l01345"></a>01345     <span class="keywordflow">if</span> (ev-&gt;region-&gt;style&gt;=0) {
<a name="l01346"></a>01346       <span class="keywordtype">size_t</span> idx=ev-&gt;region-&gt;style;
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (idx&lt;k-&gt;ki-&gt;nstyles) {
<a name="l01348"></a>01348         ev-&gt;style=k-&gt;ki-&gt;styles[idx];
<a name="l01349"></a>01349       }
<a name="l01350"></a>01350     }
<a name="l01351"></a>01351   }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353   <span class="keywordflow">if</span> (ev-&gt;id&gt;=0) {
<a name="l01354"></a>01354     <span class="comment">/* register the event as active */</span>
<a name="l01355"></a>01355     ret=kate_decode_state_add_event(k-&gt;kds,ev);
<a name="l01356"></a>01356     RNDERR(error);
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01358"></a>01358   }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360   ret=kate_decode_state_flush_events(k-&gt;kds,ev-&gt;start);
<a name="l01361"></a>01361   RNDERR(error);
<a name="l01362"></a>01362   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">goto</span> error;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364   <span class="keywordflow">return</span> KMG_OK();
<a name="l01365"></a>01365 
<a name="l01366"></a>01366 error_limit:
<a name="l01367"></a>01367   ret=KATE_E_LIMIT;
<a name="l01368"></a>01368   <span class="keywordflow">goto</span> error;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 error_bad_packet:
<a name="l01371"></a>01371   ret=KATE_E_BAD_PACKET;
<a name="l01372"></a>01372   <span class="keywordflow">goto</span> error;
<a name="l01373"></a>01373 
<a name="l01374"></a>01374 error_out_of_memory:
<a name="l01375"></a>01375   ret=KATE_E_OUT_OF_MEMORY;
<a name="l01376"></a>01376   <span class="keywordflow">goto</span> error;
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 ignore:
<a name="l01379"></a>01379   <span class="comment">/* special case where we need to destroy the event as we&apos;re not interested in it,</span>
<a name="l01380"></a>01380 <span class="comment">     but we do not want an error to be raised */</span>
<a name="l01381"></a>01381   ret=0;
<a name="l01382"></a>01382   <span class="keywordflow">goto</span> error;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 error:
<a name="l01385"></a>01385   <span class="comment">/* all the memory allocated for the event should be freed by the kate_memory_guard,</span>
<a name="l01386"></a>01386 <span class="comment">     so we just unlink and jettison it */</span>
<a name="l01387"></a>01387   kate_free(kds-&gt;event);
<a name="l01388"></a>01388   kds-&gt;event=NULL;
<a name="l01389"></a>01389   <span class="keywordflow">return</span> KMG_ERROR(ret);
<a name="l01390"></a>01390 }
<a name="l01391"></a>01391 
<a name="l01392"></a>01392 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_repeat_packet(kate_state *k,kate_pack_buffer *kpb)
<a name="l01393"></a>01393 {
<a name="l01394"></a>01394   <span class="keywordflow">return</span> kate_decode_text_packet(k,kpb,1);
<a name="l01395"></a>01395 }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_keepalive_packet(kate_state *k,kate_pack_buffer *kpb)
<a name="l01398"></a>01398 {
<a name="l01399"></a>01399   <span class="keywordflow">if</span> (!k || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01400"></a>01400   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01401"></a>01401 
<a name="l01402"></a>01402   <span class="keywordflow">return</span> 0;
<a name="l01403"></a>01403 }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 <span class="keyword">static</span> <span class="keywordtype">int</span> kate_decode_end_packet(kate_state *k,kate_pack_buffer *kpb)
<a name="l01406"></a>01406 {
<a name="l01407"></a>01407   <span class="keywordflow">if</span> (!k || !kpb) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01408"></a>01408   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01409"></a>01409 
<a name="l01410"></a>01410   <span class="keywordflow">return</span> 1;
<a name="l01411"></a>01411 }
<a name="l01412"></a>01412 
<a name="l01422"></a>01422 <span class="keywordtype">int</span> kate_decode_packetin(kate_state *k,kate_packet *kp)
<a name="l01423"></a>01423 {
<a name="l01424"></a>01424   kate_pack_buffer kpb;
<a name="l01425"></a>01425   <span class="keywordtype">int</span> ret,id;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427   <span class="keywordflow">if</span> (!k || !kp) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01428"></a>01428   <span class="keywordflow">if</span> (!k-&gt;ki) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01429"></a>01429   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01430"></a>01430 
<a name="l01431"></a>01431   ret=kate_decode_state_clear(k-&gt;kds,k-&gt;ki,0);
<a name="l01432"></a>01432   <span class="keywordflow">if</span> (ret&lt;0) <span class="keywordflow">return</span> ret;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434   kate_pack_readinit(&amp;kpb,kp-&gt;data,kp-&gt;nbytes);
<a name="l01435"></a>01435   <span class="keywordtype">id</span>=kate_pack_read(&amp;kpb,8);
<a name="l01436"></a>01436   <span class="keywordflow">if</span> (<span class="keywordtype">id</span>&amp;0x80) {
<a name="l01437"></a>01437     <span class="comment">/* we have a header - we&apos;ll ignore it</span>
<a name="l01438"></a>01438 <span class="comment">       it may have happened either because we seeked to the beginning of the stream</span>
<a name="l01439"></a>01439 <span class="comment">       or because we&apos;re parsing a stream that has more headers than we know about */</span>
<a name="l01440"></a>01440     <span class="keywordflow">return</span> 0;
<a name="l01441"></a>01441   }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443   <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {
<a name="l01444"></a>01444     <span class="keywordflow">case</span> 0x00: <span class="keywordflow">return</span> kate_decode_text_packet(k,&amp;kpb,0);
<a name="l01445"></a>01445     <span class="keywordflow">case</span> 0x01: <span class="keywordflow">return</span> kate_decode_keepalive_packet(k,&amp;kpb);
<a name="l01446"></a>01446     <span class="keywordflow">case</span> 0x02: <span class="keywordflow">return</span> kate_decode_repeat_packet(k,&amp;kpb);
<a name="l01447"></a>01447     <span class="keywordflow">case</span> 0x7f: <span class="keywordflow">return</span> kate_decode_end_packet(k,&amp;kpb);
<a name="l01448"></a>01448     <span class="keywordflow">default</span>: <span class="keywordflow">return</span> 0; <span class="comment">/* unknown data packets are ignored, for future proofing */</span>
<a name="l01449"></a>01449   }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451   <span class="keywordflow">return</span> 0;
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01463"></a>01463 <span class="keywordtype">int</span> kate_decode_eventout(kate_state *k,kate_const kate_event **event)
<a name="l01464"></a>01464 {
<a name="l01465"></a>01465   <span class="keywordflow">if</span> (!k) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01466"></a>01466   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468   <span class="keywordflow">if</span> (!k-&gt;kds-&gt;event) <span class="keywordflow">return</span> 1;
<a name="l01469"></a>01469 
<a name="l01470"></a>01470   <span class="keywordflow">if</span> (event) *<span class="keyword">event</span>=k-&gt;kds-&gt;event;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472   <span class="keywordflow">return</span> 0;
<a name="l01473"></a>01473 }
<a name="l01474"></a>01474 
<a name="l01485"></a>01485 <span class="keywordtype">int</span> kate_decode_seek(kate_state *k)
<a name="l01486"></a>01486 {
<a name="l01487"></a>01487   <span class="keywordflow">if</span> (!k) <span class="keywordflow">return</span> KATE_E_INVALID_PARAMETER;
<a name="l01488"></a>01488   <span class="keywordflow">if</span> (!k-&gt;kds) <span class="keywordflow">return</span> KATE_E_INIT;
<a name="l01489"></a>01489 
<a name="l01490"></a>01490   <span class="keywordflow">return</span> kate_decode_state_flush_events(k-&gt;kds,-1);
<a name="l01491"></a>01491 }
<a name="l01492"></a>01492 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Sun Aug 21 12:55:17 2011 for libkate by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.0 </small></address>
</body>
</html>
